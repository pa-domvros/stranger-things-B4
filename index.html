<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stranger Things: The Byzantine Curse</title>
    <style>
        /* --- CSS: CUSTOM FONTS & STYLE --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Creepster&display=swap');

        /* Try to load local font if available, fallback to Creepster */
        @font-face {
            font-family: 'StrangerThings';
            src: url('benguiat.ttf'); 
        }

        :root {
            --stranger-red: #e71d36;
            --neon-blue: #00f3ff;
            --void-black: #050505;
            --bulb-yellow: #ffea00;
            --bulb-green: #39ff14;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--void-black);
            color: #eee;
            font-family: 'Roboto Mono', monospace;
            margin: 0;
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            user-select: none; 
        }

        /* UI: HEALTH BAR */
        #health-hud {
            position: fixed;
            top: 15px; 
            right: 15px;
            font-family: 'StrangerThings', 'Creepster', serif;
            font-size: 0.75rem; 
            color: var(--stranger-red);
            z-index: 1000;
            text-shadow: 0 0 5px red;
            display: none; 
        }

        /* EFFECTS */
        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* TITLE */
        h1.logo {
            font-family: 'StrangerThings', 'Creepster', serif;
            color: transparent;
            -webkit-text-stroke: 2px var(--stranger-red);
            font-size: 2.3rem; 
            text-transform: uppercase;
            text-align: center;
            letter-spacing: -2px;
            margin-bottom: 15px; 
            filter: drop-shadow(0 0 5px var(--stranger-red)) drop-shadow(0 0 15px var(--stranger-red));
            animation: breathe 4s infinite ease-in-out;
            line-height: 1;
        }

        
        /* AUDIO TOAST (shows when browser blocks autoplay / to unmute) */
        #audio-toast{
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.78);
            color: #fff;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 0.95rem;
            z-index: 10000;
            display: none;
            box-shadow: 0 0 18px rgba(231, 29, 54, 0.35);
            cursor: pointer;
            user-select: none;
        }
        #audio-toast:hover{
            transform: translateX(-50%) scale(1.02);
        }
    @keyframes breathe {
            0%, 100% { filter: drop-shadow(0 0 5px var(--stranger-red)) drop-shadow(0 0 10px var(--stranger-red)); }
            50% { filter: drop-shadow(0 0 10px var(--stranger-red)) drop-shadow(0 0 30px var(--stranger-red)); }
        }

        /* SCREENS & CONTAINERS */
        .screen {
            position: absolute; 
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background: var(--void-black);
            padding: 15px; 
            overflow-y: auto; /* Allow scrolling if content is tall */
        }
        
        .active { display: flex; }

        /* SETTING CARD */
        .setting-card {
            border: 3px solid var(--stranger-red);
            background: rgba(20, 0, 0, 0.8);
            padding: 10px; 
            border-radius: 10px;
            box-shadow: 0 0 25px var(--stranger-red);
            text-align: center;
            max-width: 90%;
            max-height: 60vh; 
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .setting-card img {
            max-width: 100%;
            max-height: 45vh; 
            width: auto; 
            object-fit: contain;
            border: 2px solid #550000;
        }

        /* CAROUSEL */
        #carousel-image {
            max-height: 60vh;
            max-width: 90%;
            border: 4px solid var(--stranger-red);
            box-shadow: 0 0 30px var(--stranger-red);
            opacity: 0; 
            transition: opacity 0.5s ease-in-out;
        }
        .fade-in-image { opacity: 1 !important; }

        /* DIALOGUE BOX */
        .dialogue-box {
            border: 2px solid var(--neon-blue);
            background: rgba(0, 15, 30, 0.95);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            box-shadow: 0 0 15px var(--neon-blue);
            text-align: left;
            width: 90%; max-width: 800px; 
            font-size: 0.95rem; 
        }

        .character-name {
            color: var(--neon-blue);
            font-weight: bold;
            text-transform: uppercase;
            display: block;
            text-shadow: 0 0 5px var(--neon-blue);
            margin-bottom: 5px;
        }

        /* BUTTONS */
        button {
            background: transparent;
            border: 2px solid #fff;
            color: #fff;
            padding: 10px 20px;
            font-family: 'StrangerThings', 'Creepster', serif;
            font-size: 1.2rem; 
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
            margin-top: 10px; 
            letter-spacing: 1px;
        }
        
        button:hover {
            background: var(--stranger-red);
            border-color: var(--stranger-red);
            box-shadow: 0 0 20px var(--stranger-red);
        }

        /* --- WHEEL STYLES --- */
        .wheel-box {
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 5;
            width: auto;
            height: auto;
            margin: 10px 0;
        }

        canvas#wheel {
            /* BULLETPROOF SQUARE FIX */
            width: clamp(200px, 70vmin, 500px); 
            height: clamp(200px, 70vmin, 500px);
            display: block;
            filter: drop-shadow(0 0 15px rgba(231, 29, 54, 0.4));
        }

        .pointer {
            position: absolute; 
            top: -15px; 
            left: 50%; 
            transform: translateX(-50%);
            width: 0; 
            height: 0;
            border-left: 20px solid transparent; 
            border-right: 20px solid transparent;
            border-bottom: 35px solid #fff;
            filter: drop-shadow(0 0 10px #fff);
            z-index: 10; 
        }

        /* CENTERED OVERLAY FOR RESULT */
        #wheel-overlay-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            text-align: center;
            width: 90%;
            pointer-events: none; 
        }
        
        #wheel-overlay-center.active {
            pointer-events: auto; 
        }

        .result {
            font-family: 'StrangerThings', serif; 
            font-size: clamp(1rem, 2.5vw, 2rem);
            color: #fff;
            text-shadow: 0 0 10px #fff, 0 0 30px var(--stranger-red);
            opacity: 0;
            transition: opacity 0.3s ease;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border: 2px solid var(--stranger-red);
            border-radius: 10px;
            box-shadow: 0 0 30px var(--stranger-red);
            margin-bottom: 10px;
        }
        .result.show { opacity: 1; animation: flicker 0.15s infinite; }

        /* LEVEL 1: LOGIC GRID */
        .logic-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px; 
            margin: 15px 0; 
            width: 90%; max-width: 800px;
        }
        .grid-item {
            border: 1px solid #555;
            padding: 15px 5px; 
            cursor: pointer;
            background: #1a1a1a;
            text-align: center;
            font-family: 'StrangerThings', 'Creepster', serif;
            font-size: 0.9rem; 
            transition: 0.2s;
        }

        /* LEVEL 2, 4 & 5 HUD */
        .arcade-hud, .scramble-hud {
            display: flex;
            justify-content: space-between;
            width: 90%; max-width: 800px;
            font-family: 'Creepster', cursive;
            color: gold;
            font-size: 1.2rem;
            margin-bottom: 8px; 
        }

        /* ARCADE & GREEK QUESTION BOX */
        #arcade-question-box, #greek-question-box {
             width: 90%; max-width: 800px;
             background: #111; 
             padding: 15px; 
             border: 2px solid lime; 
             font-family: 'Courier New', monospace; 
             color: lime; 
             text-align: center; 
             box-shadow: 0 0 10px lime;
             font-size: 1.1rem;
             line-height: 1.4;
        }
        
        #greek-question-box {
            border-color: var(--neon-blue);
            color: #fff;
            box-shadow: 0 0 10px var(--neon-blue);
            font-family: 'Roboto Mono', monospace; /* Better for Greek */
        }

        /* LEVEL 4: SCRAMBLE UI */
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px; 
            margin-top: 15px;
            width: 90%; max-width: 800px;
        }
        .scramble-slot {
            display: inline-block;
            border-bottom: 2px solid white;
            min-width: 30px; 
            margin: 0 4px;
            color: var(--neon-blue);
            font-weight: bold;
        }

        /* FOOTER */
        footer {
            position: fixed;
            bottom: 5px;
            width: 100%;
            text-align: center;
            font-family: 'StrangerThings', 'Creepster', serif;
            color: #666;
            font-size: 0.7rem;
            z-index: 1000;
        }

        /* ANIMATIONS */
        .fade-out { opacity: 0; transition: opacity 1s ease; }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        #red-flash {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: #a00;
            opacity: 0;
            pointer-events: none;
            z-index: 998;
            transition: opacity 0.1s;
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div id="red-flash"></div>

    <div id="health-hud">
        LIVES: <span id="lives-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
    </div>

    <div id="setting-screen" class="screen active">
        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
            <img src="logo.png" alt="Logo" style="height: 100px; width: auto; object-fit: contain; filter: drop-shadow(0 0 10px #e71d36);">
            <h1 class="logo" style="margin: 0; text-align: center; line-height: 1;">
                STRANGER THINGS<br>THE BYZANTINE CURSE
            </h1>
        </div>
        
        <div class="setting-card">
            <img src="setting.png" alt="The Upside Down Classroom">
        </div>
        <button id="enterClassB4Btn" onclick="showNarrative()">ENTER CLASS B4</button>
    </div>

    <div id="narrative-screen" class="screen">
        <h1 class="logo">THE POSSESSION<br>OF MR. DOMVROS</h1>
        
        <p style="color: #bbb; max-width: 800px; text-align: center; margin-top: 10px; line-height: 1.4; font-family: 'Roboto Mono', monospace; font-size: 1.3rem;">
            1ST MIDDLE SCHOOL OF PYLEA, CLASS B4.<br><br>
            Mr. Domvros is acting strange. His eyes are black. He has locked the door and declared himself <span style="color:var(--stranger-red)">EMPEROR OF THE CLASSROOM</span>.<br><br>
            He has been possessed by a strict Byzantine Emperor from the Upside Down. He has started a History Test that never ends.<br><br>
            You must use your <strong>English Skills</strong> to solve his <strong>History Riddles</strong> and break the curse.<br><br>
            <span style="color:var(--stranger-red)">Volume ON recommended. Good luck, B4.</span>
        </p>
        <button onclick="startGame()">ENTER AT YOUR OWN RISK</button>
    </div>

    <div id="carousel-screen" class="screen">
        <img id="carousel-image" src="" alt="Character Sequence">
    </div>

    <div id="wheel-intro-screen" class="screen">
        <h1 class="logo" style="font-size: 2.2rem; color: var(--stranger-red);">THE VOID AWAKENS</h1>
        <div class="dialogue-box" style="text-align: center;">
            <p style="color: #ccc; font-size: 1.2rem; line-height: 1.5;">
                <span style="color: var(--stranger-red); font-weight: bold;">ERROR... REGISTER CORRUPTED...</span><br><br>
                The Emperor's voice booms through the static:<br>
                <em>"I demand a tribute! One student must step forward to prove their worth!"</em><br><br>
                The Mind Flayer is scrolling through the class list...
            </p>
        </div>
        <button onclick="enterLevel('wheel-level')">SUMMON THE WHEEL</button>
    </div>

    <div id="wheel-level" class="screen">
        <h1 class="logo" style="font-size: clamp(1.1rem, 2.5vw, 2rem); margin: 0 0 10px 0; line-height: 1.1; padding: 0 10px;">
            WHO WILL LEAD THE REBELLION?
        </h1>

        <button id="spinBtn" onclick="spinWheel()">RUN</button>

        <div class="wheel-box">
            <div class="pointer"></div>
            
            <div id="wheel-overlay-center">
                <div class="result" id="wheel-result"></div>
                <br>
                <button id="wheel-continue-btn" style="display:none; color: var(--bulb-green); border-color: var(--bulb-green); font-size: 1.5rem; background: #000; white-space: nowrap;" onclick="enterLevel('level-1')">
                    ACCEPT CHALLENGE
                </button>
            </div>

            <canvas id="wheel" width="1000" height="1000"></canvas>
        </div>
    </div>

    <div id="level-1" class="screen">
        <h1 class="logo" style="font-size: 2rem;">CHAPTER 1:<br>THE NIKA RIOTS</h1>
        
        <div class="dialogue-box">
            <span class="character-name">MARIA P (READING THE CHRONICLE):</span>
            "The Emperor is angry! We must seat the Factions correctly in the Hippodrome to stop the Riot!"<br>
            <div style="color:#ccc; font-style: italic; margin-top: 10px; line-height: 1.5; border: 1px solid #555; padding: 10px; background: #111;">
                "<strong>Maria A.</strong> says the <span style="color:var(--bulb-green)">GREEN</span> faction <em>is sitting</em> next to the Blue one.
                <strong>Spiros S.</strong> notices that the <span style="color:var(--stranger-red)">RED</span> guards <em>are standing</em> at the very end (Position 4).
                <strong>Spiros R.</strong> warns that the <span style="color:var(--neon-blue)">BLUE</span> faction is <strong>more aggressive than</strong> the Yellow one, so they are in the first seat (Position 1).
                Therefore, the <strong>YELLOW</strong> faction takes the only empty seat left."
            </div>
        </div>

        <div class="logic-grid" id="bulb-container">
            <div class="grid-item" id="slot-1" onclick="cycleColor(1)" style="color: #555;">[SEAT 1]</div>
            <div class="grid-item" id="slot-2" onclick="cycleColor(2)" style="color: #555;">[SEAT 2]</div>
            <div class="grid-item" id="slot-3" onclick="cycleColor(3)" style="color: #555;">[SEAT 3]</div>
            <div class="grid-item" id="slot-4" onclick="cycleColor(4)" style="color: #555;">[SEAT 4]</div>
        </div>

        <button onclick="checkLevel1()">CONNECT</button>
        <p id="msg-1" style="min-height: 20px; color: var(--stranger-red); font-weight: bold; margin-top:10px; font-family:'StrangerThings', serif; font-size:1.5rem;"></p>
    </div>

    <div id="level-2" class="screen">
        <h1 class="logo" style="font-size: 2rem;">CHAPTER 2:<br>THE GRAMMAR SIEGE</h1>
        
        <div class="arcade-hud">
            <div>BOSS: EMPEROR DOMVROS</div>
            <div id="boss-hp">HP: 8/8</div>
        </div>

        <div class="dialogue-box" style="min-height: auto;">
            <span class="character-name">JOHN:</span>
            "He is throwing rapid-fire questions about History and Grammar! We need 8 correct answers to block the attack!"
        </div>

        <div id="arcade-question-box">
            </div>
        
        <p id="msg-2" style="min-height: 20px; color: var(--stranger-red); font-weight: bold; margin-top:10px; font-family:'StrangerThings', serif; font-size:1.5rem;"></p>
    </div>

    <div id="level-3" class="screen">
        <h1 class="logo" style="font-size: 2rem;">CHAPTER 3:<br>THE FORBIDDEN WORDS</h1>
        
        <div class="dialogue-box" style="min-height: auto;">
            <span class="character-name">STRATIS:</span>
            "The curse is weakening! We must define the secret words correctly to seal the rift!"
        </div>

        <div id="vocab-container" style="width:100%; text-align: center; margin-top: 15px;">
            </div>

        <p id="msg-3" style="min-height: 20px; color: var(--stranger-red); font-weight: bold; margin-top:10px; font-family:'StrangerThings', serif; font-size:1.5rem;"></p>
    </div>

    <div id="level-4" class="screen">
        <h1 class="logo" style="font-size: 2rem;">CHAPTER 4:<br>THE GOLDEN AGE</h1>
        
        <div class="scramble-hud" style="color: var(--neon-blue);">
            <div>DECODE HISTORY</div>
            <div id="scramble-progress">1/4</div>
        </div>

        <div class="dialogue-box" style="min-height: auto;">
            <span class="character-name">ELEFTHERIA:</span>
            "I found the Emperor's secret scroll! Unscramble the sentences to break the spell completely!"
        </div>

        <div style="margin: 15px; font-size: 1.1rem; min-height: 35px; border-bottom: 1px solid #333; width: 90%; max-width: 800px; padding:5px;" id="scramble-answer-area">
        </div>

        <div class="word-bank" id="scramble-bank">
        </div>

        <div style="margin-top:15px;">
            <button onclick="resetScramble()" style="font-size:0.9rem; border-color:#555; color:#aaa; margin-right:10px; padding: 8px 15px;">RESET</button>
            <button onclick="checkLevel4()" style="font-size:0.9rem; padding: 8px 15px;">DECODE</button>
        </div>
        
        <p id="msg-4" style="min-height: 20px; color: var(--stranger-red); font-weight: bold; margin-top:10px; font-family:'StrangerThings', serif; font-size:1.2rem;"></p>
    </div>

    <div id="level-5" class="screen">
        <h1 class="logo" style="font-size: 2rem;">CHAPTER 5:<br>THE GREEK CHALLENGE</h1>
        
        <div class="arcade-hud">
            <div>FINAL BATTLE</div>
            <div id="greek-progress">1/20</div>
        </div>

        <div class="dialogue-box" style="min-height: auto;">
            <span class="character-name">MR. DOMVROS (POSSESSED):</span>
            "Impressive, but can you pass the FINAL EXAM? Answer in the language of the Empire!"
        </div>

        <div id="greek-question-box">
            </div>

        <div style="margin-top: 20px; display: flex; gap: 20px;">
            <button onclick="checkLevel5(true)" style="color: #39ff14; border-color: #39ff14; box-shadow: 0 0 10px #39ff14;">TRUE</button>
            <button onclick="checkLevel5(false)" style="color: #e71d36; border-color: #e71d36; box-shadow: 0 0 10px #e71d36;">FALSE</button>
        </div>
        
        <p id="msg-5" style="min-height: 20px; color: var(--stranger-red); font-weight: bold; margin-top:10px; font-family:'StrangerThings', serif; font-size:1.5rem;"></p>
    </div>

    <div id="fail-screen" class="screen" style="background:black; z-index:2000;">
        <h1 class="logo" style="color: red; -webkit-text-stroke: 2px red;">YOU DIED</h1>
        <p style="font-size: 1.2rem; text-align:center;">The History Test lasts forever.<br>You are trapped in the classroom.</p>
        <button onclick="restartCurrentLevel()">TRY AGAIN</button>
    </div>

    <div id="win-screen" class="screen">
        <h1 class="logo">CURSE BROKEN</h1>
        <p style="font-family:'Roboto Mono', monospace; margin-top: 20px; text-align:center; max-width:600px;">
            You have saved Class B4!<br><br>
            Mr. Domvros blinks and looks around. "Why is everyone sweating? Did we have a test?"<br><br>
            You are safe... until the next lesson.
        </p>
        <button onclick="location.reload()">PLAY AGAIN</button>
    </div>

    <footer>
         Created for Class B4 by Mr. Domvros, Principal of 1st Middle School of Pylea , English and Drama Teacher
    </footer>

    <script>
        // --- ASSETS ---
// Ensure these files exist in the same folder
const audioWrong = new Audio('audio.mp3');
// Intro bed on first page load (loops until first ENTER CLASS B4 click)
const audioIntro = new Audio('audio.mp3');
audioIntro.loop = true;
audioIntro.volume = 0.6; 
const audioMain = new Audio('main.mp3'); 
audioMain.volume = 0.5;

// --- NEW SFX / LOOPS ---
// Static loop for "THE VOID AWAKENS" card
const audioStatic = new Audio('static.mp3');
audioStatic.loop = true;
audioStatic.volume = 0.6;

// Demo: used both as a looping suspense bed (wheel RUN) and as a chapter-start cue
const audioDemoLoop = new Audio('demo.mp3');
audioDemoLoop.loop = true;
audioDemoLoop.volume = 0.6;

const audioDemoCue = new Audio('demo.mp3');
audioDemoCue.loop = false;
audioDemoCue.volume = 0.8;

function playLoop(audio){
    try {
        audio.pause();
        audio.currentTime = 0;
        audio.loop = true;
        audio.play().catch(e => console.log("Audio play error", e));
    } catch(e) {}
}

function playOnce(audio){
    try {
        audio.pause();
        audio.currentTime = 0;
        audio.loop = false;
        audio.play().catch(e => console.log("Audio play error", e));
    } catch(e) {}
}

function stopAudio(audio){
    try {
        audio.pause();
        audio.currentTime = 0;
    } catch(e) {}
}



// --- INTRO AUDIO (audio.mp3) ---
// Starts looping on the first screen. Autoplay may be blocked by the browser.
// Strategy: try muted autoplay; if blocked (or muted), show a toast prompting a tap to enable sound.
// Stops permanently (this session) on the first "ENTER CLASS B4" click.
let introStopped = false;

function ensureAudioToast(){
    let toast = document.getElementById('audio-toast');
    if (toast) return toast;
    toast = document.createElement('div');
    toast.id = 'audio-toast';
    toast.textContent = 'üîä Tap anywhere to enable sound';
    toast.addEventListener('click', unlockIntroAudio, true);
    document.body.appendChild(toast);
    return toast;
}

function showAudioToast(){
    ensureAudioToast().style.display = 'block';
}

function hideAudioToast(){
    const toast = document.getElementById('audio-toast');
    if (toast) toast.style.display = 'none';
}

async function tryAutoplayMuted(){
    if (introStopped) return;
    audioIntro.loop = true;
    audioIntro.volume = 0.6;
    audioIntro.muted = true; // improves autoplay success rate on many browsers
    try {
        await audioIntro.play();
        // It may be playing muted; prompt user to enable sound.
        showAudioToast();
    } catch (e) {
        // Autoplay blocked; prompt user to tap to start audio.
        showAudioToast();
    }
}

function unlockIntroAudio(e){
    if (introStopped) return;

    // If the first interaction is the ENTER button, don't bother enabling sound (it stops immediately).
    const enterBtn = document.getElementById('enterClassB4Btn');
    if (enterBtn && e && (e.target === enterBtn || enterBtn.contains(e.target))) return;

    audioIntro.muted = false;
    audioIntro.loop = true;

    if (audioIntro.paused) {
        audioIntro.play().then(() => {
            hideAudioToast();
        }).catch(() => {
            // Still blocked; keep the toast visible.
            showAudioToast();
        });
    } else {
        // Already playing (likely muted) ‚Äî just unmute.
        hideAudioToast();
    }
}

function startIntroAudio(){
    if (introStopped) return;
    tryAutoplayMuted();

    // Capture-phase listeners so we can unlock sound as early as possible on a user gesture.
    document.addEventListener('pointerdown', unlockIntroAudio, true);
    document.addEventListener('keydown', unlockIntroAudio, true);
}

function stopIntroAudio(){
    if (introStopped) return;
    introStopped = true;
    hideAudioToast();
    stopAudio(audioIntro);
    document.removeEventListener('pointerdown', unlockIntroAudio, true);
    document.removeEventListener('keydown', unlockIntroAudio, true);
}

// Start immediately (and retry on full load as well)
startIntroAudio();
window.addEventListener('load', startIntroAudio);



        // --- CAROUSEL DATA ---
        // Ensure these images exist in the same folder
        const carouselImages = ['Lucas.png', 'Mike.png', 'Will.png', 'Eleven.png', 'Dustin.png', 'Jonathan.png', 'Nancy.png', 'Demogorgon.png', 'domvros.png'];
        let carouselIndex = 0;

        // --- GAME STATE ---
        let currentLives = 5; 
        let currentLevelId = 'level-1'; 
        
        // --- WHEEL STATE & CONFIG ---
        const FIXED_NAMES = [
            "Emily", "Panagiota", "Nicole", "Maria P.", "Maria A.", 
            "Konstantinos", "Alex", "Simon", "Kostis", "Spiros S.", 
            "Spiros R.", "Markos", "John", "Markela", "Stratis", 
            "Stergios", "Thomas", "Christos", "Antonis", "Vasilis", 
            "Anastasia", "Eleftheria", "Ioanna", "Kleon", "Vasiliki", "George"
        ];
        const WHEEL_COLORS = ['#050505', '#990000', '#222222', '#e71d36'];
        const WHEEL_TEXT_SIZE = 32;
        let wheelState = { items: [...FIXED_NAMES], angle: 0, spinning: false };
        let __audioCtx = null;

        // --- LEVEL DATA ---

        // Level 1 Data (Logic: Blue->Green->Yellow->Red)
        const colors = ["BLUE", "RED", "GREEN", "YELLOW"];
        let slots = [0, 0, 0, 0]; 
        
        // Level 2 Data (8 Hybrid Questions)
        const arcadeQuestions = [
            { q: "1. The Hagia Sophia is ______ (impressive) church in the Empire.", opts: ["the most impressive", "more impressive"], ans: "the most impressive" },
            { q: "2. Heraclius ______ (defeat) the Persians and recovered the Holy Cross.", opts: ["defeated", "was defeating"], ans: "defeated" },
            { q: "3. Konstantinos ______ (believe) that Greek Fire is dangerous.", opts: ["believes", "is believing"], ans: "believes" },
            { q: "4. Justinian was ______ (ambitious) than his predecessors.", opts: ["more ambitious", "ambitiouser"], ans: "more ambitious" },
            { q: "5. The Arabs ______ (introduce) spices and paper to the West.", opts: ["introduced", "did introduced"], ans: "introduced" },
            { q: "6. Look! Alex and Kostis ______ (run) to the walls right now!", opts: ["are running", "run"], ans: "are running" },
            { q: "7. While Simon was reading about the Themes, the bell ______ (ring).", opts: ["rang", "was ringing"], ans: "rang" },
            { q: "8. Markos is the soldier ______ saved the Emperor.", opts: ["who", "whose"], ans: "who" }
        ];
        let arcadeStage = 0;

        // Level 3 Data (12 Items - Mixed History, Grammar & Buildings)
        // correct answers are mixed up (not always first)
        const vocabChallenges = [
            // History Terms
            { target: "The movement that destroyed images.", opts: ["Heresy", "Iconoclasm", "Idolatry"], ans: "Iconoclasm" },
            { target: "Soldiers who guarded the borders.", opts: ["Akrites", "Knights", "Themes"], ans: "Akrites" },
            { target: "A picture made of small colored stones.", opts: ["Fresco", "Mosaic", "Portrait"], ans: "Mosaic" },
            { target: "The Great Church built by Justinian.", opts: ["Hagia Sophia", "Pantheon", "Parthenon"], ans: "Hagia Sophia" },
            
            // Grammar (Simple Past vs Past Perfect)
            { target: "When the police arrived, the thief ______ (escape).", opts: ["escaped", "has escaped", "had escaped"], ans: "had escaped" },
            { target: "I was tired because I ______ (work) hard all day.", opts: ["worked", "had worked", "have worked"], ans: "had worked" },
            { target: "She realized she ______ (lose) her book.", opts: ["had lost", "lost", "loses"], ans: "had lost" },
            { target: "After the Emperor ______ (sign) the treaty, peace returned.", opts: ["signed", "had signed", "signing"], ans: "had signed" },

            // PDF Terms (Buildings)
            { target: "A large strong building with towers and high walls.", opts: ["Hut", "Castle", "Villa"], ans: "Castle" },
            { target: "A very tall building often found in cities.", opts: ["Skyscraper", "Tower", "Monument"], ans: "Skyscraper" },
            { target: "A house made of blocks of ice.", opts: ["Chalet", "Igloo", "Cave"], ans: "Igloo" },
            { target: "Vertical stone posts used to support a roof.", opts: ["Walls", "Pillars", "Beams"], ans: "Pillars" }
        ];
        let vocabStage = 0;

        // Level 4 Data (4 Sentences)
        // Last sentence shortened as requested
        const scrambleData = [
            { correct: ["GREEK", "FIRE", "WAS", "MORE", "DANGEROUS", "THAN", "ARROWS"], mixed: ["DANGEROUS", "WAS", "THAN", "ARROWS", "FIRE", "MORE", "GREEK"] },
            { correct: ["BASIL", "WAS", "THE", "STRONGEST", "EMPEROR", "OF", "THE", "DYNASTY"], mixed: ["EMPEROR", "STRONGEST", "THE", "OF", "WAS", "DYNASTY", "THE", "BASIL"] },
            { correct: ["JUSTINIAN", "DID", "NOT", "LEAVE", "THE", "CITY", "DURING", "THE", "RIOTS"], mixed: ["LEAVE", "NOT", "DID", "RIOTS", "THE", "DURING", "CITY", "THE", "JUSTINIAN"] },
            { correct: ["WE", "HAVE", "LEARNED", "THAT", "ARABS", "TRADED", "SPICES"], mixed: ["TRADED", "HAVE", "ARABS", "SPICES", "THAT", "LEARNED", "WE"] }
        ];
        let scrambleStage = 0;
        let scrambleUserBuild = [];

        // Level 5 Data (20 Greek Questions)
        const greekQuestions = [
            { q: "Œü ŒöœâŒΩœÉœÑŒ±ŒΩœÑŒØŒΩŒøœÇ Œë' ŒµœÄŒ≠ŒªŒµŒæŒµ œÑŒ∑ Œ∏Œ≠œÉŒ∑ œÑŒøœÖ Œ±œÅœáŒ±ŒØŒøœÖ ŒíœÖŒ∂Œ±ŒΩœÑŒØŒøœÖ Œ≥ŒπŒ± œÑŒ∑ ŒΩŒ≠Œ± œÄœÅœâœÑŒµœçŒøœÖœÉŒ±, ŒµœÄŒµŒπŒ¥ŒÆ Œ≤œÅŒπœÉŒ∫œåœÑŒ±ŒΩ œÉœÑŒø œÉœÑŒ±œÖœÅŒøŒ¥œÅœåŒºŒπ ŒëœÉŒØŒ±œÇ Œ∫Œ±Œπ ŒïœÖœÅœéœÄŒ∑œÇ.", ans: true },
            { q: "Œ§Œø ŒîŒπŒ¨œÑŒ±Œ≥ŒºŒ± œÑœâŒΩ ŒúŒµŒ¥ŒπŒøŒªŒ¨ŒΩœâŒΩ (313 Œº.Œß.) ŒµœÄŒ≠Œ≤Œ±ŒªŒµ œÑŒøŒΩ ŒßœÅŒπœÉœÑŒπŒ±ŒΩŒπœÉŒºœå œâœÇ œÑŒ∑ ŒºŒøŒΩŒ±Œ¥ŒπŒ∫ŒÆ Œ∏œÅŒ∑œÉŒ∫ŒµŒØŒ± œÑŒøœÖ Œ°œâŒºŒ±œäŒ∫Œøœç ŒöœÅŒ¨œÑŒøœÖœÇ.", ans: false },
            { q: "Œü ŒôŒøœÖœÉœÑŒπŒΩŒπŒ¨ŒΩŒµŒπŒøœÇ ŒöœéŒ¥ŒπŒ∫Œ±œÇ œÄŒµœÅŒπŒªŒ¨ŒºŒ≤Œ±ŒΩŒµ œÑŒøœÖœÇ ŒΩŒ≠ŒøœÖœÇ ŒΩœåŒºŒøœÖœÇ œÄŒøœÖ ŒµŒ∫Œ¥œåŒ∏Œ∑Œ∫Œ±ŒΩ ŒºŒµœÑŒ¨ œÑŒø 534 Œº.Œß.", ans: false },
            { q: "Œó ŒëŒ≥ŒØŒ± Œ£ŒøœÜŒØŒ± Œ±ŒΩŒÆŒ∫ŒµŒπ œÉœÑŒøŒΩ Œ±œÅœáŒπœÑŒµŒ∫œÑŒøŒΩŒπŒ∫œå œÅœÖŒ∏Œºœå œÑŒ∑œÇ Œ≤Œ±œÉŒπŒªŒπŒ∫ŒÆœÇ ŒºŒµœÑŒ¨ œÑœÅŒøœçŒªŒøœÖ.", ans: true },
            { q: "Œü ŒóœÅŒ¨Œ∫ŒªŒµŒπŒøœÇ œÖŒπŒøŒ∏Œ≠œÑŒ∑œÉŒµ œÑŒøŒΩ ŒµŒªŒªŒ∑ŒΩŒπŒ∫œå œÑŒØœÑŒªŒø ¬´Œ≤Œ±œÉŒπŒªŒµœçœÇ¬ª ŒºŒµ œÑŒ∑ŒΩ œÄœÅŒøœÉŒ∏ŒÆŒ∫Œ∑ ¬´œÄŒπœÉœÑœåœÇ ŒµŒΩ ŒßœÅŒπœÉœÑœé¬ª.", ans: true },
            { q: "Œü Œ∏ŒµŒºŒ±œÑŒπŒ∫œåœÇ œÉœÑœÅŒ±œÑœåœÇ Œ±œÄŒøœÑŒµŒªŒøœçŒΩœÑŒ±ŒΩ Œ∫œÖœÅŒØœâœÇ Œ±œÄœå ŒæŒ≠ŒΩŒøœÖœÇ ŒºŒπœÉŒ∏ŒøœÜœåœÅŒøœÖœÇ.", ans: false },
            { q: "Œó ŒïŒπŒ∫ŒøŒΩŒøŒºŒ±œáŒØŒ± ŒæŒµŒ∫ŒØŒΩŒ∑œÉŒµ Œ±œÄœå œÑŒøœÖœÇ Œ±œÖœÑŒøŒ∫œÅŒ¨œÑŒøœÅŒµœÇ œÑŒ∑œÇ Œ¥œÖŒΩŒ±œÉœÑŒµŒØŒ±œÇ œÑœâŒΩ ŒôœÉŒ±œçœÅœâŒΩ (ŒõŒ≠œâŒΩ Œì' Œ∫Œ±Œπ ŒöœâŒΩœÉœÑŒ±ŒΩœÑŒØŒΩŒøœÇ Œï').", ans: true },
            { q: "Œó Œñ' ŒüŒπŒ∫ŒøœÖŒºŒµŒΩŒπŒ∫ŒÆ Œ£œçŒΩŒøŒ¥ŒøœÇ (787) Œ±œÄŒ±Œ≥œåœÅŒµœÖœÉŒµ ŒøœÅŒπœÉœÑŒπŒ∫Œ¨ œÑŒ∑ œáœÅŒÆœÉŒ∑ œÑœâŒΩ ŒµŒπŒ∫œåŒΩœâŒΩ.", ans: false },
            { q: "ŒüŒπ ¬´Œ∫Œ±Œ∫œéœÉŒµŒπœÇ¬ª œÑŒøœÖ ŒùŒπŒ∫Œ∑œÜœåœÅŒøœÖ Œë' ŒÆœÑŒ±ŒΩ ŒøŒπŒ∫ŒøŒΩŒøŒºŒπŒ∫Œ¨ ŒºŒ≠œÑœÅŒ± œÄŒøœÖ œÉœÑœåœáŒµœÖŒ±ŒΩ œÉœÑŒ∑ŒΩ Œ±œçŒæŒ∑œÉŒ∑ œÑœâŒΩ Œ∫œÅŒ±œÑŒπŒ∫œéŒΩ ŒµœÉœåŒ¥œâŒΩ.", ans: true },
            { q: "Œó Œ£œáŒøŒªŒÆ œÑŒ∑œÇ ŒúŒ±Œ≥ŒΩŒ±œçœÅŒ±œÇ ŒπŒ¥œÅœçŒ∏Œ∑Œ∫Œµ ŒºŒµ œÄœÅœâœÑŒøŒ≤ŒøœÖŒªŒØŒ± œÑŒøœÖ ŒöŒ±ŒØœÉŒ±œÅŒ± ŒíŒ¨œÅŒ¥Œ±.", ans: true },
            { q: "Œü ŒöœâŒΩœÉœÑŒ±ŒΩœÑŒØŒΩŒøœÇ (ŒöœçœÅŒπŒªŒªŒøœÇ) Œ∫Œ±Œπ Œø ŒúŒµŒ∏œåŒ¥ŒπŒøœÇ œáœÅŒ∑œÉŒπŒºŒøœÄŒøŒØŒ∑œÉŒ±ŒΩ œÑŒø ŒªŒ±œÑŒπŒΩŒπŒ∫œå Œ±ŒªœÜŒ¨Œ≤Œ∑œÑŒø Œ≥ŒπŒ± œÑŒøŒΩ ŒµŒ∫œáœÅŒπœÉœÑŒπŒ±ŒΩŒπœÉŒºœå œÑœâŒΩ Œ£ŒªŒ¨Œ≤œâŒΩ.", ans: false },
            { q: "Œü Œ†Œ±œÑœÅŒπŒ¨œÅœáŒ∑œÇ Œ¶œéœÑŒπŒøœÇ Œ∫Œ±œÑŒÆŒ≥Œ≥ŒµŒπŒªŒµ œÑŒ∑ŒΩ ŒµœÄŒ≠ŒºŒ≤Œ±œÉŒ∑ œÑŒ∑œÇ Œ°œâŒºŒ±œäŒ∫ŒÆœÇ ŒïŒ∫Œ∫ŒªŒ∑œÉŒØŒ±œÇ œÉœÑŒ∑ ŒíŒøœÖŒªŒ≥Œ±œÅŒØŒ±.", ans: true },
            { q: "Œü Œ±œÖœÑŒøŒ∫œÅŒ¨œÑŒøœÅŒ±œÇ ŒíŒ±œÉŒØŒªŒµŒπŒøœÇ Œí' œÉœÖŒΩŒ≠œÑœÅŒπœàŒµ œÑŒøœÖœÇ ŒíŒøœÖŒªŒ≥Œ¨œÅŒøœÖœÇ œÉœÑŒ∑ ŒºŒ¨œáŒ∑ œÑŒøœÖ ŒöŒªŒµŒπŒ¥ŒØŒøœÖ (1014).", ans: true },
            { q: "ŒüŒπ œÉœÖŒΩŒµœáŒµŒØœÇ œÄœåŒªŒµŒºŒøŒπ œÑŒ∑œÇ ŒúŒ±Œ∫ŒµŒ¥ŒøŒΩŒπŒ∫ŒÆœÇ Œ¥œÖŒΩŒ±œÉœÑŒµŒØŒ±œÇ ŒøŒ¥ŒÆŒ≥Œ∑œÉŒ±ŒΩ œÉŒµ ŒøŒπŒ∫ŒøŒΩŒøŒºŒπŒ∫ŒÆ œáœÅŒµŒøŒ∫ŒøœÄŒØŒ± œÑŒø Œ∫œÅŒ¨œÑŒøœÇ.", ans: false },
            { q: "ŒüŒπ ŒÜœÅŒ±Œ≤ŒµœÇ Œ≠ŒºœÄŒøœÅŒøŒπ ŒµœÄŒπŒΩœåŒ∑œÉŒ±ŒΩ œÑŒ∑ŒΩ ŒµŒºœÄŒøœÅŒπŒ∫ŒÆ ŒµœÄŒπœÑŒ±Œ≥ŒÆ (œÑœÉŒµŒ∫).", ans: true },
            { q: "Œó Œ±œÅŒ±Œ≤ŒπŒ∫ŒÆ œÑŒ≠œáŒΩŒ∑ œáŒ±œÅŒ±Œ∫œÑŒ∑œÅŒØŒ∂ŒµœÑŒ±Œπ Œ±œÄœå œÑŒ∑ŒΩ Œ±œÜŒ∏ŒøŒΩŒØŒ± ŒµŒπŒ∫œåŒΩœâŒΩ œÄœÅŒøœÉœéœÄœâŒΩ.", ans: false },
            { q: "Œü ŒôŒøœÖœÉœÑŒπŒΩŒπŒ±ŒΩœåœÇ Œ∫Œ±œÑŒ≠ŒªœÖœÉŒµ œÑŒø ŒíŒ±ŒΩŒ¥Œ±ŒªŒπŒ∫œå Œ∫œÅŒ¨œÑŒøœÇ œÉœÑŒ∑ ŒíœåœÅŒµŒπŒ± ŒëœÜœÅŒπŒ∫ŒÆ.", ans: true },
            { q: "Œ§Œø Œ≠œÅŒ≥Œø ¬´ŒúœÖœÅŒπœåŒ≤ŒπŒ≤ŒªŒøœÇ¬ª Œ≥œÅŒ¨œÜœÑŒ∑Œ∫Œµ Œ±œÄœå œÑŒøŒΩ ŒõŒ≠ŒøŒΩœÑŒ± œÑŒøŒΩ ŒúŒ±Œ∏Œ∑ŒºŒ±œÑŒπŒ∫œå.", ans: false },
            { q: "Œü ŒóœÅŒ¨Œ∫ŒªŒµŒπŒøœÇ Œ±ŒΩŒ≠Œ∫œÑŒ∑œÉŒµ œÑŒøŒΩ Œ§ŒØŒºŒπŒø Œ£œÑŒ±œÖœÅœå Œ±œÄœå œÑŒøœÖœÇ Œ†Œ≠œÅœÉŒµœÇ.", ans: true },
            { q: "Œ§Œ± ŒëŒ∫œÅŒπœÑŒπŒ∫Œ¨ œÑœÅŒ±Œ≥ŒøœçŒ¥ŒπŒ± œÖŒºŒΩŒøœçŒΩ œÑŒ∑ Œ∂œâŒÆ œÑœâŒΩ ŒµŒºœÄœåœÅœâŒΩ œÉœÑŒπœÇ ŒºŒµŒ≥Œ¨ŒªŒµœÇ œÄœåŒªŒµŒπœÇ.", ans: false }
        ];
        let greekStage = 0;

        // --- GLOBAL FUNCTIONS ---

        function showNarrative() {
            // Stop intro bed on the first ENTER CLASS B4 click
            stopIntroAudio();
            const settingScreen = document.getElementById('setting-screen');
            settingScreen.classList.add('fade-out');
            setTimeout(() => {
                settingScreen.classList.remove('active');
                settingScreen.classList.remove('fade-out'); 
                document.getElementById('narrative-screen').classList.add('active');
            }, 1000); 
        }

        function startGame() {
            audioMain.currentTime = 0;
            audioMain.play().catch(e => console.log("Main Audio error", e));

            const narrativeScreen = document.getElementById('narrative-screen');
            narrativeScreen.classList.add('fade-out');
            setTimeout(() => {
                narrativeScreen.classList.remove('active');
                narrativeScreen.classList.remove('fade-out');
                document.getElementById('carousel-screen').classList.add('active');
                runCarousel();
            }, 1000); 
        }

        function runCarousel() {
            if (carouselIndex < carouselImages.length) {
                const imgElement = document.getElementById('carousel-image');
                imgElement.src = carouselImages[carouselIndex];
                setTimeout(() => imgElement.classList.add('fade-in-image'), 50);

                setTimeout(() => {
                    imgElement.classList.remove('fade-in-image');
                    setTimeout(() => {
                        carouselIndex++;
                        runCarousel();
                    }, 500);
                }, 2000); 
            } else {
                endCarousel();
            }
        }

        function endCarousel() {
             fadeAudio(audioMain);
             document.getElementById('carousel-screen').classList.remove('active');
             document.getElementById('health-hud').style.display = 'block';
             // Go to Wheel Suspense
             enterLevel('wheel-intro-screen');
        }

        function enterLevel(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            currentLevelId = id;

            // --- AUDIO TRIGGERS ---
            // 1) static.mp3: starts when "THE VOID AWAKENS" (wheel-intro-screen) appears; stops when you leave it.
            if (id === 'wheel-intro-screen') playLoop(audioStatic);
            else stopAudio(audioStatic);

            // 2) demo.mp3 loop: started by RUN (spinWheel); always stop it when leaving wheel screen.
            if (id !== 'wheel-level') stopAudio(audioDemoLoop);

            // 3) demo.mp3 cue: play every time a new chapter begins (CHAPTER screens).
            if (['level-1','level-2','level-3','level-4','level-5'].includes(id)) {
                playOnce(audioDemoCue);
            }

            
            // Re-draw wheel if entering wheel screen to ensure correct sizing
            if(id === 'wheel-level') {
                 drawWheel();
                 document.getElementById('wheel-continue-btn').style.display = 'none';
                 document.getElementById('spinBtn').disabled = false;
                 document.getElementById('wheel-result').classList.remove('show');
                 document.getElementById('wheel-result').innerText = "";
                 document.getElementById('wheel-overlay-center').classList.remove('active');
            }

            if(id === 'level-1') currentLives = 5;
            updateLivesDisplay();
            
            if(id === 'level-2') { arcadeStage = 0; loadArcadeQuestion(); }
            if(id === 'level-3') { vocabStage = 0; loadVocab(); }
            if(id === 'level-4') { 
                scrambleStage = 0; 
                updateScrambleProgress();
                resetScramble(); 
            }
            if(id === 'level-5') {
                greekStage = 0;
                loadGreekQuestion();
            }
        }

        function updateLivesDisplay() {
            let hearts = "";
            for(let i=0; i<currentLives; i++) hearts += "‚ù§Ô∏è";
            document.getElementById('lives-display').innerText = hearts;
        }

        function loseLife() {
            currentLives--;
            updateLivesDisplay();
            triggerShake();
            if(currentLives <= 0) {
                setTimeout(() => {
                    document.getElementById('fail-screen').classList.add('active');
                }, 500);
            }
        }

        function restartCurrentLevel() {
            document.getElementById('fail-screen').classList.remove('active');
            currentLives = 5; // Reset lives on retry
            updateLivesDisplay();
            enterLevel(currentLevelId);
        }

        function fadeAudio(audio) {
            let fadeInterval = setInterval(() => {
                if (audio.volume > 0.05) audio.volume -= 0.05;
                else { audio.pause(); clearInterval(fadeInterval); }
            }, 200);
        }

        function triggerShake() {
            audioWrong.currentTime = 0; 
            audioWrong.play().catch(e => console.log("Audio error", e));
            document.body.classList.add('shake');
            setTimeout(() => document.body.classList.remove('shake'), 500);
            const flash = document.getElementById('red-flash');
            flash.style.opacity = '0.4';
            setTimeout(() => flash.style.opacity = '0', 200);
        }

        // --- WHEEL LOGIC ---
        function initAudio() {
            if (!window.AudioContext && !window.webkitAudioContext) return;
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                __audioCtx = new AudioCtx();
            } catch(e) {}
        }

        function playTick(){
            if (!__audioCtx) return;
            try {
                const o = __audioCtx.createOscillator(); 
                const g = __audioCtx.createGain();
                o.type = 'sawtooth'; 
                o.frequency.value = 80; 
                g.gain.setValueAtTime(0.1, __audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.001, __audioCtx.currentTime + 0.05);
                o.connect(g); g.connect(__audioCtx.destination);
                o.start(); o.stop(__audioCtx.currentTime + 0.05);
            } catch(e) {}
        }

        function playWin(){
            if (!__audioCtx) return;
            try {
                const o = __audioCtx.createOscillator(); 
                const g = __audioCtx.createGain();
                o.type = 'square';
                o.frequency.setValueAtTime(110, __audioCtx.currentTime);
                o.frequency.exponentialRampToValueAtTime(50, __audioCtx.currentTime + 0.8);
                g.gain.setValueAtTime(0.3, __audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.001, __audioCtx.currentTime + 0.8);
                o.connect(g); g.connect(__audioCtx.destination);
                o.start(); o.stop(__audioCtx.currentTime + 0.8);
            } catch(e) {}
        }

        function drawWheel() {
            const canvas = document.getElementById('wheel');
            const ctx = canvas.getContext('2d');
            const W = canvas.width;
            const H = canvas.height;
            const cx = W/2, cy = H/2; 
            const R = Math.min(W,H)/2 - 30; 

            ctx.clearRect(0,0,W,H);

            const n = wheelState.items.length;
            const slice = Math.PI * 2 / n;

            for (let i=0;i<n;i++){
                const start = wheelState.angle + i*slice;
                const end = start + slice;
                ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,start,end); ctx.closePath();
                ctx.fillStyle = WHEEL_COLORS[i % WHEEL_COLORS.length]; ctx.fill();
                ctx.strokeStyle = '#e71d36'; ctx.lineWidth = 4; ctx.stroke();

                const label = wheelState.items[i];
                ctx.save();
                ctx.translate(cx,cy);
                ctx.rotate((start+end)/2);
                ctx.textAlign = 'right';
                if (i % 2 === 0) { ctx.fillStyle = '#fff'; ctx.shadowColor = '#e71d36'; } 
                else { ctx.fillStyle = '#e71d36'; ctx.shadowColor = '#000'; }
                ctx.shadowBlur = 10;
                ctx.font = `bold ${WHEEL_TEXT_SIZE}px 'Roboto Mono', monospace`;
                ctx.fillText(label, R-40, 10);
                ctx.restore();
            }
            ctx.beginPath(); ctx.arc(cx,cy, R*0.15, 0, Math.PI*2); 
            ctx.fillStyle = '#000'; ctx.fill();
            ctx.strokeStyle = '#e71d36'; ctx.lineWidth = 6; ctx.stroke();
        }

        function spinWheel(){
            if (wheelState.spinning) return;
            if (!__audioCtx) initAudio();
            if (__audioCtx && __audioCtx.state === 'suspended') __audioCtx.resume();

            
            // Start demo.mp3 loop immediately when RUN is clicked (until ACCEPT CHALLENGE / leaving this screen)
            playLoop(audioDemoLoop);
wheelState.spinning = true; 
            const btn = document.getElementById('spinBtn');
            btn.disabled = true;
            document.getElementById('wheel-result').classList.remove('show');
            document.getElementById('wheel-result').innerText = "";
            document.getElementById('wheel-continue-btn').style.display = 'none';
            document.getElementById('wheel-overlay-center').classList.remove('active');

            const dur = 5; 
            const revs = 5 + Math.random() * 5; 
            const n = wheelState.items.length; 
            const slice = Math.PI*2/n;
            const targetIndex = Math.floor(Math.random() * n);
            const targetAngle = -Math.PI/2 - (targetIndex + 0.5)*slice;
            const extraTurns = revs * Math.PI*2;
            const startAngle = wheelState.angle;
            
            let delta = targetAngle - startAngle;
            while (delta < 0) delta += Math.PI*2;
            delta += extraTurns;

            const start = performance.now();
            let nextTickAngle = startAngle + slice;

            // Ease Out Cubic
            const ease = t => 1 - Math.pow(1 - t, 3);
            const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

            function step(now){
                const t = clamp((now - start) / (dur*1000), 0, 1);
                const eased = ease(t);
                
                wheelState.angle = startAngle + delta * eased;
                
                if (wheelState.angle > nextTickAngle){ 
                    playTick(); 
                    nextTickAngle += slice; 
                }
                
                drawWheel();
                
                if (t < 1) {
                    requestAnimationFrame(step); 
                } else { 
                    wheelState.spinning = false; 
                    settleWinner(); 
                }
            }
            requestAnimationFrame(step);
        }

        function settleWinner(){
            const n = wheelState.items.length;
            const slice = Math.PI*2/n;
            const a = (wheelState.angle % (Math.PI*2) + Math.PI*2) % (Math.PI*2);
            const fromTop = (a + Math.PI/2) % (Math.PI*2);
            let idx = Math.floor(fromTop / slice);
            idx = (n - 1 - idx + n) % n;

            const winner = wheelState.items[idx];
            
            const resEl = document.getElementById('wheel-result');
            resEl.textContent = winner.toUpperCase();
            resEl.classList.add('show');
            playWin();

            // Enable overlay interactivity
            document.getElementById('wheel-overlay-center').classList.add('active');
            
            // Show Proceed Button centered
            document.getElementById('wheel-continue-btn').style.display = 'inline-block';
        }

        // --- KEYBOARD SUPPORT ---
        document.addEventListener('keydown', function(event) {
            if (event.key === "Enter") {
                if (document.getElementById('setting-screen').classList.contains('active')) {
                    showNarrative();
                } else if (document.getElementById('narrative-screen').classList.contains('active')) {
                    startGame();
                } else if (document.getElementById('level-1').classList.contains('active')) {
                    checkLevel1();
                } else if (document.getElementById('level-4').classList.contains('active')) {
                    checkLevel4();
                } else if (document.getElementById('fail-screen').classList.contains('active')) {
                    restartCurrentLevel();
                } else if (document.getElementById('win-screen').classList.contains('active')) {
                    location.reload();
                } else if (document.getElementById('wheel-intro-screen').classList.contains('active')) {
                    enterLevel('wheel-level');
                }
            }
        });
    </script>
</body>
</html>